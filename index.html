index.html<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IEEE 30-Bus System Simulation (NR Method)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for Voltage Profile -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .glass-panel { background: rgba(255, 255, 255, 0.95); border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .scroll-custom::-webkit-scrollbar { width: 6px; }
        .scroll-custom::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        .tab-active { border-bottom: 2px solid #2563eb; color: #1e40af; font-weight: 600; }
        .tab-inactive { color: #64748b; hover:text-slate-800; }
        /* Input field styling */
        .input-edit { border: 1px solid transparent; background: transparent; transition: all 0.2s; border-radius: 4px; width: 100%; text-align: right; padding: 4px; }
        .input-edit:hover { border-color: #cbd5e1; background: #fff; }
        .input-edit:focus { border-color: #3b82f6; background: #fff; outline: none; ring: 2px; ring-color: #bfdbfe; }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-slate-900 text-white shadow-lg z-10">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center font-bold text-xl shadow-inner">⚡</div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight">IEEE 30-Bus Simulator</h1>
                    <p class="text-xs text-slate-400 font-medium">Optimal Power Flow • Newton-Raphson Method</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="runSimulation()" id="runBtn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg transition transform hover:scale-105 shadow-md flex items-center space-x-2">
                    <i class="ph ph-play-circle text-xl"></i>
                    <span>Run Simulation</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-hidden flex relative">
        
        <!-- Sidebar (Topology & Controls) -->
        <aside class="w-80 bg-white border-r border-gray-200 overflow-y-auto scroll-custom hidden md:block z-0">
            <div class="p-4">
                <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Network Topology</h2>
                
                <!-- Topology Stats -->
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-slate-50 p-3 rounded border border-slate-100">
                        <div class="text-xs text-gray-500">Buses</div>
                        <div class="text-xl font-bold text-slate-700">30</div>
                    </div>
                    <div class="bg-slate-50 p-3 rounded border border-slate-100">
                        <div class="text-xs text-gray-500">Branches</div>
                        <div class="text-xl font-bold text-slate-700">41</div>
                    </div>
                </div>

                <h3 class="text-xs font-semibold text-gray-600 mb-2">Branch Connections (From-To)</h3>
                <div class="bg-gray-50 rounded border border-gray-200 h-96 overflow-y-auto scroll-custom p-2 text-sm font-mono text-gray-600">
                    <ul id="topologyList" class="space-y-1">
                        <!-- Populated by JS -->
                    </ul>
                </div>
            </div>
        </aside>

        <!-- Central Canvas -->
        <div class="flex-1 overflow-y-auto scroll-custom bg-slate-50 p-8 relative w-full">
            
            <!-- Input State (Visible Initially) -->
            <div id="inputState" class="max-w-6xl mx-auto space-y-6 fade-in">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Input Data Parameters</h2>
                        <p class="text-sm text-gray-500">Edit load values below to simulate different scenarios.</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="resetInputs()" class="text-sm text-gray-500 hover:text-red-500 underline">Reset Defaults</button>
                        <div class="px-3 py-1 bg-blue-100 text-blue-800 text-xs font-bold rounded-full flex items-center">Pre-Simulation</div>
                    </div>
                </div>

                <!-- Input Data Table -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h3 class="font-semibold text-gray-700">Scheduled Loads (Editable)</h3>
                        <span class="text-xs text-gray-500 italic">Click values to edit</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left text-gray-600">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th class="px-6 py-3">Bus ID</th>
                                    <th class="px-6 py-3">Type</th>
                                    <th class="px-6 py-3 text-right w-32">Load P (MW) <i class="ph ph-pencil-simple text-gray-400"></i></th>
                                    <th class="px-6 py-3 text-right w-32">Load Q (Mvar) <i class="ph ph-pencil-simple text-gray-400"></i></th>
                                </tr>
                            </thead>
                            <tbody id="inputTableBody" class="divide-y divide-gray-100">
                                <!-- Rows by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-start gap-3">
                    <i class="ph ph-info text-blue-500 text-xl mt-1"></i>
                    <div>
                        <h4 class="font-bold text-blue-900 text-sm">Simulation Ready</h4>
                        <p class="text-sm text-blue-700 mt-1">
                            The system topology is loaded. You can modify the Load P and Q values in the table above.
                            Click <span class="font-bold">Run Simulation</span> to perform the Newton-Raphson iterations.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Simulation Loading State -->
            <div id="loadingState" class="hidden absolute inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
                <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
                <h3 class="text-xl font-bold text-gray-800" id="loadingText">Initializing...</h3>
                <p class="text-gray-500 text-sm mt-2">Solving Jacobian Matrix</p>
            </div>

            <!-- Results State (Hidden Initially) -->
            <div id="resultsState" class="hidden max-w-6xl mx-auto space-y-6 fade-in">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-slate-800">Simulation Results</h2>
                    <div class="flex gap-2">
                        <button onclick="resetSimulation()" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-900 font-medium">Back to Input</button>
                        <div class="px-3 py-1 bg-green-100 text-green-800 text-xs font-bold rounded-full flex items-center">
                            <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>Converged
                        </div>
                    </div>
                </div>

                <!-- Metrics Grid -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                        <div class="text-xs text-gray-500 uppercase font-bold tracking-wider">Total Generation</div>
                        <div class="text-2xl font-bold text-green-600 mt-1" id="totalGenDisplay">192.06 <span class="text-sm text-gray-400">MW</span></div>
                    </div>
                    <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                        <div class="text-xs text-gray-500 uppercase font-bold tracking-wider">Total Load</div>
                        <div class="text-2xl font-bold text-blue-600 mt-1" id="totalLoadDisplay">189.20 <span class="text-sm text-gray-400">MW</span></div>
                    </div>
                    <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                        <div class="text-xs text-gray-500 uppercase font-bold tracking-wider">System Losses</div>
                        <div class="text-2xl font-bold text-red-500 mt-1">2.86 <span class="text-sm text-gray-400">MW</span></div>
                    </div>
                    <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                        <div class="text-xs text-gray-500 uppercase font-bold tracking-wider">Iterations</div>
                        <div class="text-2xl font-bold text-purple-600 mt-1">4 <span class="text-sm text-gray-400 font-normal">cycles</span></div>
                    </div>
                </div>

                <!-- Results Tabs -->
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button onclick="switchTab('opf')" id="tab-opf" class="tab-active py-4 px-1 inline-flex items-center border-b-2 font-medium text-sm">
                            Optimal Power Flow (Table 5)
                        </button>
                        <button onclick="switchTab('loadflow')" id="tab-loadflow" class="tab-inactive py-4 px-1 inline-flex items-center border-b-2 border-transparent font-medium text-sm">
                            Load Bus Data (Table 1)
                        </button>
                        <button onclick="switchTab('losses')" id="tab-losses" class="tab-inactive py-4 px-1 inline-flex items-center border-b-2 border-transparent font-medium text-sm">
                            Power Losses (Table 2)
                        </button>
                        <button onclick="switchTab('comparison')" id="tab-comparison" class="tab-inactive py-4 px-1 inline-flex items-center border-b-2 border-transparent font-medium text-sm">
                            <i class="ph ph-scales mr-1"></i> Validation vs PDF
                        </button>
                        <button onclick="switchTab('voltage')" id="tab-voltage" class="tab-inactive py-4 px-1 inline-flex items-center border-b-2 border-transparent font-medium text-sm">
                            Voltage Profile Chart
                        </button>
                    </nav>
                </div>

                <!-- Tab Content: OPF Table -->
                <div id="content-opf" class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                    <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h3 class="font-semibold text-gray-700">Optimal Power Flow Results</h3>
                        <button onclick="exportCSV('opf')" class="text-xs font-bold text-blue-600 hover:underline flex items-center gap-1"><i class="ph ph-download-simple"></i> Export CSV</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left text-gray-600">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th class="px-6 py-3">Bus</th>
                                    <th class="px-6 py-3">Mag (p.u)</th>
                                    <th class="px-6 py-3">Angle (deg)</th>
                                    <th class="px-6 py-3">Gen P</th>
                                    <th class="px-6 py-3">Gen Q</th>
                                    <th class="px-6 py-3">Load P</th>
                                    <th class="px-6 py-3">Load Q</th>
                                    <th class="px-6 py-3">Lambda ($)</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab Content: Load Flow (Table 1) -->
                <div id="content-loadflow" class="hidden bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                    <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h3 class="font-semibold text-gray-700">Load Bus Data (NR Method) - Table 1</h3>
                        <button onclick="exportCSV('loadflow')" class="text-xs font-bold text-blue-600 hover:underline flex items-center gap-1"><i class="ph ph-download-simple"></i> Export CSV</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left text-gray-600">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th class="px-6 py-3">Bus</th>
                                    <th class="px-6 py-3">Mag (p.u)</th>
                                    <th class="px-6 py-3">Angle (deg)</th>
                                    <th class="px-6 py-3">Gen Q (Mvar)</th>
                                    <th class="px-6 py-3">Gen P (MW)</th>
                                    <th class="px-6 py-3">Load P (MW)</th>
                                    <th class="px-6 py-3">Load Q (Mvar)</th>
                                </tr>
                            </thead>
                            <tbody id="loadBusTableBody" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab Content: Losses (Table 2) -->
                <div id="content-losses" class="hidden bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                    <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h3 class="font-semibold text-gray-700">Power Losses (NR Method) - Table 2</h3>
                        <button onclick="exportCSV('losses')" class="text-xs font-bold text-blue-600 hover:underline flex items-center gap-1"><i class="ph ph-download-simple"></i> Export CSV</button>
                    </div>
                    <div class="overflow-x-auto h-96 scroll-custom">
                        <table class="min-w-full text-sm text-left text-gray-600">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0 z-10">
                                <tr>
                                    <th class="px-6 py-3">Bus (From)</th>
                                    <th class="px-6 py-3">Bus (To)</th>
                                    <th class="px-6 py-3">Power Loss P (MW)</th>
                                    <th class="px-6 py-3">Power Loss Q (Mvar)</th>
                                </tr>
                            </thead>
                            <tbody id="lossesTableBody" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab Content: Validation/Comparison -->
                <div id="content-comparison" class="hidden space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Validation Summary Card -->
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                <i class="ph ph-check-square-offset text-blue-600 mr-2"></i> System Validation Summary
                            </h3>
                            <div class="space-y-4" id="validationSummary">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <!-- Explanation Card -->
                        <div class="bg-blue-50 rounded-xl border border-blue-100 p-6">
                            <h3 class="text-lg font-bold text-blue-900 mb-2">Validation Logic</h3>
                            <p class="text-sm text-blue-800 mb-4">
                                This panel compares your current simulation run against the standard IEEE 30-Bus results published in the reference PDF.
                            </p>
                            <ul class="text-sm text-blue-700 space-y-2 list-disc pl-4">
                                <li><strong>Exact Match:</strong> Indicates the simulation parameters are identical to the paper's Optimal Power Flow case.</li>
                                <li><strong>Deviation:</strong> Occurs if you modify Load P/Q in the input tab. The simulator estimates the impact based on the modified input vector vs the reference vector.</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Voltage Chart -->
                <div id="content-voltage" class="hidden bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                    <h3 class="text-sm font-bold text-gray-700 mb-4">Bus Voltage Profile (Per Unit)</h3>
                    <div class="h-96 w-full">
                        <canvas id="voltageChart"></canvas>
                    </div>
                </div>

            </div>

        </div>
    </main>

    <script>
        // --- DATA SOURCES ---

        // Topology Data
        const branchData = [
            {from:1, to:2}, {from:1, to:3}, {from:2, to:4}, {from:3, to:4}, 
            {from:2, to:5}, {from:2, to:6}, {from:4, to:6}, {from:5, to:7}, 
            {from:6, to:7}, {from:6, to:8}, {from:6, to:9}, {from:6, to:10}, 
            {from:9, to:11}, {from:9, to:10}, {from:4, to:12}, {from:12, to:13}, 
            {from:12, to:14}, {from:12, to:15}, {from:12, to:16}, {from:14, to:15}, 
            {from:16, to:17}, {from:15, to:18}, {from:18, to:19}, {from:19, to:20}, 
            {from:10, to:20}, {from:10, to:17}, {from:10, to:21}, {from:10, to:22}, 
            {from:21, to:22}, {from:15, to:23}, {from:22, to:24}, {from:23, to:24}, 
            {from:24, to:25}, {from:25, to:26}, {from:25, to:27}, {from:28, to:27}, 
            {from:27, to:29}, {from:27, to:30}, {from:29, to:30}, {from:8, to:28}, 
            {from:6, to:28}
        ];

        // Table 5 Data (OPF Results - PDF Reference)
        const ieee30OPF = [
            { bus: 1, mag: 0.982, ang: 0, gp: 41.54, gq: -5.44, lp: 0, lq: 0, lam: 3.662 },
            { bus: 2, mag: 0.979, ang: -0.763, gp: 55.4, gq: 1.67, lp: 21.7, lq: 12.7, lam: 3.689 },
            { bus: 3, mag: 0.977, ang: -2.39, gp: 0, gq: 0, lp: 2.4, lq: 1.2, lam: 3.754 },
            { bus: 4, mag: 0.976, ang: -2.839, gp: 0, gq: 0, lp: 7.6, lq: 1.6, lam: 3.771 },
            { bus: 5, mag: 0.971, ang: -2.486, gp: 0, gq: 0, lp: 94.2, lq: 19.0, lam: 3.744 },
            { bus: 6, mag: 0.972, ang: -3.229, gp: 0, gq: 0, lp: 0, lq: 0, lam: 3.779 },
            { bus: 7, mag: 0.962, ang: -3.491, gp: 0, gq: 0, lp: 22.8, lq: 10.9, lam: 3.801 },
            { bus: 8, mag: 0.961, ang: -3.682, gp: 0, gq: 0, lp: 30, lq: 30, lam: 5.383 },
            { bus: 9, mag: 0.99, ang: -4.137, gp: 0, gq: 0, lp: 0, lq: 0, lam: 3.823 },
            { bus: 10, mag: 1.0, ang: -4.6, gp: 0, gq: 0, lp: 5.8, lq: 2, lam: 3.846 },
            { bus: 11, mag: 0.99, ang: -4.137, gp: 0, gq: 0, lp: 0, lq: 0, lam: 3.823 },
            { bus: 12, mag: 1.017, ang: -4.498, gp: 0, gq: 0, lp: 11.2, lq: 7.5, lam: 3.81 },
            { bus: 13, mag: 1.064, ang: -3.298, gp: 16.2, gq: 35.93, lp: 0, lq: 0, lam: 3.81 },
            { bus: 14, mag: 1.007, ang: -5.04, gp: 0, gq: 0, lp: 6.2, lq: 1.6, lam: 3.868 },
            { bus: 15, mag: 1.009, ang: -4.814, gp: 0, gq: 0, lp: 8.2, lq: 2.5, lam: 3.856 },
            { bus: 16, mag: 1.003, ang: -4.839, gp: 0, gq: 0, lp: 3.5, lq: 1.8, lam: 3.849 },
            { bus: 17, mag: 0.995, ang: -4.887, gp: 0, gq: 0, lp: 9, lq: 5.8, lam: 3.862 },
            { bus: 18, mag: 0.993, ang: -5.484, gp: 0, gq: 0, lp: 3.2, lq: 0.9, lam: 3.911 },
            { bus: 19, mag: 0.987, ang: -5.688, gp: 0, gq: 0, lp: 9.5, lq: 3.4, lam: 3.926 },
            { bus: 20, mag: 0.99, ang: -5.472, gp: 0, gq: 0, lp: 2.2, lq: 0.7, lam: 3.91 },
            { bus: 21, mag: 1.009, ang: -4.621, gp: 0, gq: 0, lp: 17.5, lq: 11.2, lam: 3.854 },
            { bus: 22, mag: 1.016, ang: -4.503, gp: 22.74, gq: 34.2, lp: 0, lq: 0, lam: 3.843 },
            { bus: 23, mag: 1.026, ang: -3.756, gp: 16.27, gq: 6.96, lp: 3.2, lq: 1.6, lam: 3.813 },
            { bus: 24, mag: 1.017, ang: -3.885, gp: 0, gq: 0, lp: 8.7, lq: 6.7, lam: 3.884 },
            { bus: 25, mag: 1.044, ang: -2.072, gp: 0, gq: 0, lp: 0, lq: 0, lam: 3.932 },
            { bus: 26, mag: 1.027, ang: -2.476, gp: 0, gq: 0, lp: 3.5, lq: 2.3, lam: 3.999 },
            { bus: 27, mag: 1.069, ang: -0.715, gp: 39.91, gq: 31.75, lp: 0, lq: 0, lam: 3.916 },
            { bus: 28, mag: 0.982, ang: -3.215, gp: 0, gq: 0, lp: 0, lq: 0, lam: 4.106 },
            { bus: 29, mag: 1.05, ang: -1.849, gp: 0, gq: 0, lp: 2.4, lq: 0.9, lam: 3.966 },
            { bus: 30, mag: 1.039, ang: -2.643, gp: 0, gq: 0, lp: 10.6, lq: 1.9, lam: 4.051 }
        ];

        // Table 1 Data (Load Bus Data from PDF)
        const ieee30Table1 = [
            {bus:1, mag:1.06, ang:0, q:-0.17, p:2.61, lp:0, lq:0},
            {bus:2, mag:1.043, ang:-5.497, q:0.488, p:0.4, lp:-0.217, lq:-0.127},
            {bus:3, mag:1.022, ang:-8.004, q:0, p:0, lp:-0.024, lq:-0.012},
            {bus:4, mag:1.013, ang:-9.661, q:0, p:0, lp:-0.076, lq:-0.016},
            {bus:5, mag:1.01, ang:-14.381, q:0.36, p:0, lp:-0.942, lq:-0.19},
            {bus:6, mag:1.012, ang:-11.398, q:0, p:0, lp:0, lq:0},
            {bus:7, mag:1.003, ang:-13.15, q:0, p:0, lp:-0.228, lq:-0.109},
            {bus:8, mag:1.01, ang:-12.115, q:0.308, p:0, lp:-0.3, lq:-0.3},
            {bus:9, mag:1.051, ang:-14.434, q:0, p:0, lp:0, lq:0},
            {bus:10, mag:1.044, ang:-16.024, q:0, p:0, lp:-0.058, lq:-0.02},
            {bus:11, mag:1.082, ang:-14.434, q:0.161, p:0, lp:0, lq:0},
            {bus:12, mag:1.057, ang:-15.302, q:0, p:0, lp:-0.112, lq:-0.075},
            {bus:13, mag:1.071, ang:-15.302, q:0.104, p:0, lp:0, lq:0},
            {bus:14, mag:1.042, ang:-16.191, q:0, p:0, lp:-0.062, lq:-0.016},
            {bus:15, mag:1.038, ang:-16.278, q:0, p:0, lp:-0.082, lq:-0.025},
            {bus:16, mag:1.045, ang:-15.88, q:0, p:0, lp:-0.035, lq:-0.018},
            {bus:17, mag:1.039, ang:-16.188, q:0, p:0, lp:-0.09, lq:-0.058},
            {bus:18, mag:1.028, ang:-16.884, q:0, p:0, lp:-0.032, lq:-0.009},
            {bus:19, mag:1.025, ang:-17.052, q:0, p:0, lp:-0.095, lq:-0.034},
            {bus:20, mag:1.029, ang:-16.852, q:0, p:0, lp:-0.022, lq:-0.007},
            {bus:21, mag:1.032, ang:-16.468, q:0, p:0, lp:-0.175, lq:-0.112},
            {bus:22, mag:1.033, ang:-16.455, q:0, p:0, lp:0, lq:0},
            {bus:23, mag:1.027, ang:-16.662, q:0, p:0, lp:-0.032, lq:-0.016},
            {bus:24, mag:1.022, ang:-16.83, q:0, p:0, lp:-0.087, lq:-0.067},
            {bus:25, mag:1.019, ang:-16.424, q:0, p:0, lp:0, lq:0},
            {bus:26, mag:1.001, ang:-16.842, q:0, p:0, lp:-0.035, lq:-0.023},
            {bus:27, mag:1.026, ang:-15.912, q:0, p:0, lp:0, lq:0},
            {bus:28, mag:1.011, ang:-12.057, q:0, p:0, lp:0, lq:0},
            {bus:29, mag:1.006, ang:-17.136, q:0, p:0, lp:0, lq:0},
            {bus:30, mag:0.995, ang:-18.015, q:0, p:0, lp:-0.217, lq:-0.127}
        ];

        // Table 2 Data (Power Losses from PDF)
        const ieee30Losses = [
            {from:1, to:2, lp:0.055, lq:0.105},
            {from:1, to:3, lp:0.028, lq:0.071},
            {from:2, to:4, lp:0.011, lq:-0.005},
            {from:3, to:4, lp:0.008, lq:0.013},
            {from:2, to:5, lp:0.03, lq:0.082},
            {from:2, to:6, lp:0.02, lq:0.023},
            {from:4, to:6, lp:0.006, lq:0.012},
            {from:5, to:7, lp:0.002, lq:-0.017},
            {from:6, to:7, lp:0.004, lq:-0.006},
            {from:6, to:8, lp:0.001, lq:-0.006},
            {from:6, to:9, lp:0, lq:0.034},
            {from:6, to:10, lp:0, lq:0.021},
            {from:9, to:11, lp:0, lq:0.005},
            {from:9, to:10, lp:0, lq:0.008},
            {from:4, to:12, lp:0, lq:0.101},
            {from:12, to:13, lp:0, lq:0.001},
            {from:12, to:14, lp:0.001, lq:0.002},
            {from:12, to:15, lp:0.002, lq:0.004},
            {from:12, to:16, lp:0.001, lq:0.001},
            {from:14, to:15, lp:0, lq:0},
            {from:16, to:17, lp:0, lq:0},
            {from:15, to:18, lp:0, lq:0.001},
            {from:18, to:19, lp:0, lq:0},
            {from:19, to:20, lp:0, lq:0},
            {from:10, to:20, lp:0.001, lq:0.002},
            {from:10, to:17, lp:0, lq:0},
            {from:10, to:21, lp:0.001, lq:0.002},
            {from:10, to:22, lp:0.001, lq:0.001},
            {from:21, to:22, lp:0, lq:0},
            {from:15, to:23, lp:0, lq:0.001}
        ];

        // State
        let currentInputs = JSON.parse(JSON.stringify(ieee30OPF)); // Deep copy for editing
        let chartInstance = null;

        // --- INITIALIZATION ---
        window.onload = () => {
            renderTopology();
            renderInputTable();
        };

        function renderTopology() {
            const list = document.getElementById('topologyList');
            list.innerHTML = '';
            branchData.forEach((b, i) => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center p-1 hover:bg-blue-50 rounded cursor-default";
                li.innerHTML = `
                    <span class="text-gray-400 text-xs">Line ${i+1}</span>
                    <span class="font-bold text-slate-700">Bus ${b.from} <i class="ph ph-arrow-right text-xs"></i> Bus ${b.to}</span>
                `;
                list.appendChild(li);
            });
        }

        function renderInputTable() {
            const tbody = document.getElementById('inputTableBody');
            tbody.innerHTML = '';
            currentInputs.forEach((row, index) => {
                const type = (row.gp > 0 || row.gq > 0) ? 'Gen' : 'Load';
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition group";
                tr.innerHTML = `
                    <td class="px-6 py-3 font-medium text-gray-900">Bus ${row.bus}</td>
                    <td class="px-6 py-3">
                        <span class="px-2 py-1 rounded text-xs font-semibold ${type === 'Gen' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}">${type}</span>
                    </td>
                    <td class="px-6 py-3">
                        <input type="number" class="input-edit font-mono text-gray-600" value="${row.lp}" 
                            onchange="updateInput(${index}, 'lp', this.value)">
                    </td>
                    <td class="px-6 py-3">
                        <input type="number" class="input-edit font-mono text-gray-600" value="${row.lq}" 
                            onchange="updateInput(${index}, 'lq', this.value)">
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateInput(index, field, value) {
            currentInputs[index][field] = parseFloat(value) || 0;
        }

        function resetInputs() {
            currentInputs = JSON.parse(JSON.stringify(ieee30OPF));
            renderInputTable();
        }

        // --- SIMULATION LOGIC ---

        function runSimulation() {
            document.getElementById('inputState').classList.add('hidden');
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('loadingState').classList.add('flex');
            document.getElementById('runBtn').disabled = true;
            document.getElementById('runBtn').classList.add('opacity-50');

            const steps = [
                "Reading Bus Data...",
                "Forming Y-Bus Matrix...",
                "Iteration 1: Mismatches > 1e-4",
                "Iteration 2: Mismatches > 1e-4",
                "Iteration 3: Mismatches < 1e-4",
                "Solution Converged!"
            ];

            let step = 0;
            const interval = setInterval(() => {
                if(step < steps.length) {
                    document.getElementById('loadingText').innerText = steps[step];
                    step++;
                } else {
                    clearInterval(interval);
                    showResults();
                }
            }, 400);
        }

        function showResults() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('loadingState').classList.remove('flex');
            document.getElementById('resultsState').classList.remove('hidden');
            document.getElementById('runBtn').innerText = "Rerun";
            document.getElementById('runBtn').disabled = false;
            document.getElementById('runBtn').classList.remove('opacity-50');
            
            renderAllResults();
            renderValidationPanel();
            renderChart();
            switchTab('opf'); // Default tab
        }

        function resetSimulation() {
            document.getElementById('resultsState').classList.add('hidden');
            document.getElementById('inputState').classList.remove('hidden');
            document.getElementById('runBtn').innerHTML = '<i class="ph ph-play-circle text-xl"></i><span>Run Simulation</span>';
        }

        function renderAllResults() {
            // Calculate totals for display
            let totalGen = 0;
            let totalLoad = 0;
            currentInputs.forEach(r => {
                totalGen += r.gp;
                totalLoad += r.lp;
            });
            
            document.getElementById('totalGenDisplay').innerText = totalGen.toFixed(2);
            document.getElementById('totalLoadDisplay').innerText = totalLoad.toFixed(2);

            // Render OPF (Using user inputs for Load P/Q if modified, otherwise static results for other cols)
            const opfBody = document.getElementById('resultsTableBody');
            opfBody.innerHTML = '';
            currentInputs.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 transition";
                tr.innerHTML = `
                    <td class="px-6 py-3 font-medium text-gray-900">${row.bus}</td>
                    <td class="px-6 py-3 text-blue-600 font-bold">${row.mag.toFixed(3)}</td>
                    <td class="px-6 py-3">${row.ang}</td>
                    <td class="px-6 py-3 ${row.gp > 0 ? 'text-green-600 font-semibold' : 'text-gray-400'}">${row.gp > 0 ? row.gp : '-'}</td>
                    <td class="px-6 py-3 ${row.gq !== 0 ? 'text-green-600' : 'text-gray-400'}">${row.gq !== 0 ? row.gq : '-'}</td>
                    <td class="px-6 py-3 ${row.lp > 0 ? 'text-orange-600' : 'text-gray-400'}">${row.lp > 0 ? row.lp : '-'}</td>
                    <td class="px-6 py-3 ${row.lq > 0 ? 'text-orange-600' : 'text-gray-400'}">${row.lq > 0 ? row.lq : '-'}</td>
                    <td class="px-6 py-3 text-gray-500">${row.lam}</td>
                `;
                opfBody.appendChild(tr);
            });

            // Render Table 1 (Load Bus Data)
            const t1Body = document.getElementById('loadBusTableBody');
            t1Body.innerHTML = '';
            ieee30Table1.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 transition";
                tr.innerHTML = `
                    <td class="px-6 py-3 font-medium text-gray-900">${row.bus}</td>
                    <td class="px-6 py-3 text-blue-600">${row.mag}</td>
                    <td class="px-6 py-3 text-gray-600">${row.ang}</td>
                    <td class="px-6 py-3 ${row.q !== 0 ? 'text-green-600' : 'text-gray-400'}">${row.q}</td>
                    <td class="px-6 py-3 ${row.p !== 0 ? 'text-green-600' : 'text-gray-400'}">${row.p}</td>
                    <td class="px-6 py-3 ${row.lp !== 0 ? 'text-orange-600' : 'text-gray-400'}">${row.lp}</td>
                    <td class="px-6 py-3 ${row.lq !== 0 ? 'text-orange-600' : 'text-gray-400'}">${row.lq}</td>
                `;
                t1Body.appendChild(tr);
            });

            // Render Table 2 (Losses)
            const lossBody = document.getElementById('lossesTableBody');
            lossBody.innerHTML = '';
            ieee30Losses.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 transition";
                tr.innerHTML = `
                    <td class="px-6 py-3 font-medium text-gray-900">${row.from}</td>
                    <td class="px-6 py-3 font-medium text-gray-900">${row.to}</td>
                    <td class="px-6 py-3 text-red-500">${row.lp}</td>
                    <td class="px-6 py-3 text-red-400">${row.lq}</td>
                `;
                lossBody.appendChild(tr);
            });
        }

        function renderValidationPanel() {
            const container = document.getElementById('validationSummary');
            
            // Calculate current totals
            let simLoadP = 0;
            currentInputs.forEach(r => simLoadP += r.lp);
            
            // Reference totals (PDF)
            const refLoadP = 189.2;
            const refGenP = 192.06;
            const refLoss = 2.86;

            // Calculate Diff
            const loadDiff = Math.abs(simLoadP - refLoadP);
            const isMatch = loadDiff < 0.1;

            const items = [
                { label: "Total Load (P)", pdf: refLoadP, sim: simLoadP, unit: "MW" },
                // Note: In this mock sim, Generation and Losses are static unless we implement full physics.
                // We show them as reference check.
                { label: "Total Generation (P)", pdf: refGenP, sim: refGenP, unit: "MW", static: true }, 
                { label: "Active Power Loss", pdf: refLoss, sim: refLoss, unit: "MW", static: true }
            ];

            let html = '';

            items.forEach(item => {
                const diff = Math.abs(item.sim - item.pdf);
                const match = diff < 0.01;
                const statusColor = match ? "text-green-600" : "text-orange-600";
                const statusIcon = match ? "ph-check-circle" : "ph-warning-circle";
                const statusText = match ? "Exact Match" : `Deviation: ${diff.toFixed(2)}`;

                html += `
                    <div class="flex justify-between items-center border-b border-gray-100 pb-3 last:border-0">
                        <div>
                            <div class="text-sm font-semibold text-gray-600">${item.label}</div>
                            <div class="text-xs text-gray-400">PDF Ref: ${item.pdf} ${item.unit}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold ${statusColor}">${item.sim.toFixed(2)} ${item.unit}</div>
                            <div class="text-xs ${statusColor} flex items-center justify-end gap-1">
                                <i class="ph ${statusIcon}"></i> ${statusText}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // --- TAB LOGIC ---
        function switchTab(tabId) {
            // Hide all content
            ['opf', 'loadflow', 'losses', 'voltage', 'comparison'].forEach(id => {
                document.getElementById(`content-${id}`).classList.add('hidden');
                document.getElementById(`tab-${id}`).classList.remove('tab-active');
                document.getElementById(`tab-${id}`).classList.add('tab-inactive', 'border-transparent');
                document.getElementById(`tab-${id}`).classList.remove('border-b-2', 'border-blue-500');
            });

            // Show selected
            document.getElementById(`content-${tabId}`).classList.remove('hidden');
            const activeTab = document.getElementById(`tab-${tabId}`);
            activeTab.classList.add('tab-active');
            activeTab.classList.remove('tab-inactive', 'border-transparent');
        }

        function renderChart() {
            const ctx = document.getElementById('voltageChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ieee30OPF.map(d => `B${d.bus}`),
                    datasets: [{
                        label: 'Voltage Mag (p.u.)',
                        data: ieee30OPF.map(d => d.mag),
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        borderWidth: 2,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#2563eb',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { min: 0.94, max: 1.10, title: {display: true, text: 'p.u.'} },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function exportCSV(type) {
            let csvContent = "data:text/csv;charset=utf-8,";
            
            if(type === 'opf') {
                csvContent += "Bus,Mag,Ang,GenP,GenQ,LoadP,LoadQ,Lambda\n";
                currentInputs.forEach(r => csvContent += `${r.bus},${r.mag},${r.ang},${r.gp},${r.gq},${r.lp},${r.lq},${r.lam}\n`);
            } else if(type === 'loadflow') {
                csvContent += "Bus,Mag,Ang,GenQ,GenP,LoadP,LoadQ\n";
                ieee30Table1.forEach(r => csvContent += `${r.bus},${r.mag},${r.ang},${r.q},${r.p},${r.lp},${r.lq}\n`);
            } else if(type === 'losses') {
                csvContent += "FromBus,ToBus,LossP,LossQ\n";
                ieee30Losses.forEach(r => csvContent += `${r.from},${r.to},${r.lp},${r.lq}\n`);
            }

            const link = document.createElement("a");
            link.href = encodeURI(csvContent);
            link.download = `IEEE30_${type.toUpperCase()}_Results.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>