<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IEEE 30-Bus Smart Grid Simulator (PGC/PDC & IEEE Validated)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .scroll-custom::-webkit-scrollbar { width: 6px; }
        .scroll-custom::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        .tab-active { border-bottom: 2px solid #2563eb; color: #1e40af; font-weight: 600; }
        .tab-inactive { color: #64748b; hover:text-slate-800; }
        .input-edit { border: 1px solid transparent; background: transparent; transition: all 0.2s; border-radius: 4px; width: 100%; text-align: right; padding: 4px; }
        .input-edit:hover { border-color: #cbd5e1; background: #fff; }
        .input-edit:focus { border-color: #3b82f6; background: #fff; outline: none; ring: 2px; ring-color: #bfdbfe; }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-slate-900 text-white shadow-lg z-10">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center font-bold text-xl text-slate-900 shadow-inner">PH</div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight">Smart Grid Simulator</h1>
                    <p class="text-xs text-slate-400 font-medium">IEEE 30-Bus • PGC Compliant • IEEE Validated</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="openAuthorModal()" class="text-sm text-slate-300 hover:text-white font-medium transition">
                    About Authors
                </button>
                <button onclick="runSimulation()" id="runBtn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg transition transform hover:scale-105 shadow-md flex items-center space-x-2">
                    <i class="ph ph-play-circle text-xl"></i>
                    <span>Run Simulation</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-hidden flex relative">
        
        <!-- Sidebar (Topology) -->
        <aside class="w-72 bg-white border-r border-gray-200 overflow-y-auto scroll-custom hidden md:block z-0">
            <div class="p-4">
                <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Grid Topology</h2>
                <div class="bg-slate-50 p-3 rounded border border-slate-100 mb-4">
                    <div class="text-xs text-gray-500">System Status</div>
                    <div class="text-lg font-bold text-green-600 flex items-center gap-1">
                        <span class="w-2 h-2 bg-green-500 rounded-full"></span> Normal State
                    </div>
                </div>
                <h3 class="text-xs font-semibold text-gray-600 mb-2">Transmission Lines</h3>
                <div class="bg-gray-50 rounded border border-gray-200 h-[calc(100vh-250px)] overflow-y-auto scroll-custom p-2 text-sm font-mono text-gray-600">
                    <ul id="topologyList" class="space-y-1"></ul>
                </div>
            </div>
        </aside>

        <!-- Central Canvas -->
        <div class="flex-1 overflow-y-auto scroll-custom bg-slate-50 p-8 relative w-full">
            
            <!-- Input State -->
            <div id="inputState" class="max-w-6xl mx-auto space-y-6 fade-in">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Input Parameters</h2>
                        <p class="text-sm text-gray-500">Configure loads to test Grid Code compliance.</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="resetInputs()" class="text-sm text-gray-500 hover:text-red-500 underline">Reset Defaults</button>
                        <div class="px-3 py-1 bg-blue-100 text-blue-800 text-xs font-bold rounded-full">Pre-Simulation</div>
                    </div>
                </div>

                <!-- Input Table -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h3 class="font-semibold text-gray-700">Bus Load Configuration</h3>
                        <span class="text-xs text-gray-500 italic">Editable Fields</span>
                    </div>
                    <div class="overflow-x-auto h-96 scroll-custom">
                        <table class="min-w-full text-sm text-left text-gray-600">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="px-6 py-3">Bus ID</th>
                                    <th class="px-6 py-3">Type</th>
                                    <th class="px-6 py-3 text-right">P Load (MW)</th>
                                    <th class="px-6 py-3 text-right">Q Load (Mvar)</th>
                                </tr>
                            </thead>
                            <tbody id="inputTableBody" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Loading Overlay -->
            <div id="loadingState" class="hidden absolute inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
                <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
                <h3 class="text-xl font-bold text-gray-800" id="loadingText">Initializing...</h3>
            </div>

            <!-- Results State -->
            <div id="resultsState" class="hidden max-w-6xl mx-auto space-y-6 fade-in">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-slate-800">Simulation Results</h2>
                    <button onclick="resetSimulation()" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-900 font-medium">Back to Input</button>
                </div>

                <!-- Metrics -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                        <div class="text-xs text-gray-500 uppercase font-bold">Total Generation</div>
                        <div class="text-2xl font-bold text-green-600 mt-1" id="totalGenDisplay">0 MW</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                        <div class="text-xs text-gray-500 uppercase font-bold">Total Load</div>
                        <div class="text-2xl font-bold text-blue-600 mt-1" id="totalLoadDisplay">0 MW</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                        <div class="text-xs text-gray-500 uppercase font-bold">Losses</div>
                        <div class="text-2xl font-bold text-red-500 mt-1">2.86 MW</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                        <div class="text-xs text-gray-500 uppercase font-bold">PGC Compliance</div>
                        <div class="text-2xl font-bold text-emerald-600 mt-1" id="complianceStatus">PASSED</div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8">
                        <button onclick="switchTab('compliance')" id="tab-compliance" class="tab-active py-4 px-1 border-b-2 font-medium text-sm">
                            <i class="ph ph-shield-check mr-1"></i> PGC/PDC Compliance
                        </button>
                        <button onclick="switchTab('validation')" id="tab-validation" class="tab-inactive py-4 px-1 border-b-2 border-transparent font-medium text-sm">
                            <i class="ph ph-check-square mr-1"></i> IEEE PDF Validation
                        </button>
                        <button onclick="switchTab('opf')" id="tab-opf" class="tab-inactive py-4 px-1 border-b-2 border-transparent font-medium text-sm">
                            OPF Results
                        </button>
                        <button onclick="switchTab('voltage')" id="tab-voltage" class="tab-inactive py-4 px-1 border-b-2 border-transparent font-medium text-sm">
                            Voltage Profile
                        </button>
                    </nav>
                </div>

                <!-- Compliance Tab -->
                <div id="content-compliance" class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6">
                    <div class="flex items-start gap-4 p-4 bg-yellow-50 rounded-lg border border-yellow-100">
                        <i class="ph ph-warning-circle text-yellow-600 text-2xl"></i>
                        <div>
                            <h3 class="font-bold text-yellow-900">Philippine Grid Code (PGC) Standards</h3>
                            <p class="text-sm text-yellow-800 mt-1">
                                <strong>Voltage Compliance (PGC GR 3.3.3.1):</strong> Normal State must be within <strong>0.95 p.u. to 1.05 p.u.</strong><br>
                                <strong>Distribution Code (PDC 3.2.3):</strong> Service voltage tolerance is <strong>±10% (0.90 - 1.10 p.u.)</strong>.
                            </p>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left text-gray-600">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th class="px-6 py-3">Bus ID</th>
                                    <th class="px-6 py-3">Voltage (p.u.)</th>
                                    <th class="px-6 py-3">PGC Status (±5%)</th>
                                    <th class="px-6 py-3">PDC Status (±10%)</th>
                                    <th class="px-6 py-3">Action Required</th>
                                </tr>
                            </thead>
                            <tbody id="complianceTableBody" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>

                <!-- IEEE Validation Tab -->
                <div id="content-validation" class="hidden bg-white rounded-xl border border-gray-200 shadow-sm p-6">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Benchmark Validation</h3>
                            <p class="text-sm text-gray-500">Comparison of App Simulation vs. IEEE 30-Bus PDF Data (Table 1 & 5)</p>
                        </div>
                        <div class="text-right">
                            <span class="text-xs font-bold bg-blue-100 text-blue-800 px-2 py-1 rounded">Reference: IEEE 30-Bus System PDF</span>
                        </div>
                    </div>
                    <div class="overflow-x-auto h-96 scroll-custom">
                        <table class="min-w-full text-sm text-left text-gray-600">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="px-6 py-3">Bus</th>
                                    <th class="px-6 py-3">Param</th>
                                    <th class="px-6 py-3">App Value</th>
                                    <th class="px-6 py-3">PDF Reference</th>
                                    <th class="px-6 py-3">Delta</th>
                                    <th class="px-6 py-3">Status</th>
                                </tr>
                            </thead>
                            <tbody id="validationTableBody" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>

                <!-- OPF Tab -->
                <div id="content-opf" class="hidden bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left text-gray-600">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th class="px-6 py-3">Bus</th>
                                    <th class="px-6 py-3">Mag (p.u)</th>
                                    <th class="px-6 py-3">Angle (deg)</th>
                                    <th class="px-6 py-3">Gen P</th>
                                    <th class="px-6 py-3">Load P</th>
                                    <th class="px-6 py-3">Load Q</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Voltage Tab -->
                <div id="content-voltage" class="hidden bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                    <div class="h-96 w-full">
                        <canvas id="voltageChart"></canvas>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- Author Modal -->
    <div id="authorModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden animate-[fadeIn_0.3s_ease-out]">
            <div class="bg-slate-900 p-6 text-white relative">
                <button onclick="closeAuthorModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white transition">
                    <i class="ph ph-x text-xl"></i>
                </button>
                <h3 class="text-xl font-bold">Project Authors</h3>
                <p class="text-xs text-slate-400 mt-1">Web-Based Smart Grid Simulator Design Team</p>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded transition">
                        <div class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold text-xs">NB</div>
                        <span class="font-medium text-slate-700">Napisah T. Bantog</span>
                    </div>
                    <div class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded transition">
                        <div class="w-8 h-8 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center font-bold text-xs">JB</div>
                        <span class="font-medium text-slate-700">Josa Daniela F. Bautista</span>
                    </div>
                    <div class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded transition">
                        <div class="w-8 h-8 bg-pink-100 text-pink-600 rounded-full flex items-center justify-center font-bold text-xs">JC</div>
                        <span class="font-medium text-slate-700">Joanne O. Cantos</span>
                    </div>
                    <div class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded transition">
                        <div class="w-8 h-8 bg-green-100 text-green-600 rounded-full flex items-center justify-center font-bold text-xs">FF</div>
                        <span class="font-medium text-slate-700">Fernando Jr. F. Faltado</span>
                    </div>
                    <div class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded transition">
                        <div class="w-8 h-8 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center font-bold text-xs">BL</div>
                        <span class="font-medium text-slate-700">Bryan James T. Litan</span>
                    </div>
                </div>
                <div class="mt-6 pt-6 border-t border-gray-100 text-center">
                    <p class="text-xs font-bold text-slate-800 uppercase tracking-wider">College of Engineering</p>
                    <p class="text-xs text-slate-500 mt-1">Batangas State University<br>The National Engineering University</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA SOURCES ---
        const branchData = [
            {from:1, to:2}, {from:1, to:3}, {from:2, to:4}, {from:3, to:4}, {from:2, to:5}, 
            {from:2, to:6}, {from:4, to:6}, {from:5, to:7}, {from:6, to:7}, {from:6, to:8}, 
            {from:6, to:9}, {from:6, to:10}, {from:9, to:11}, {from:9, to:10}, {from:4, to:12}, 
            {from:12, to:13}, {from:12, to:14}, {from:12, to:15}, {from:12, to:16}, {from:14, to:15}, 
            {from:16, to:17}, {from:15, to:18}, {from:18, to:19}, {from:19, to:20}, {from:10, to:20}, 
            {from:10, to:17}, {from:10, to:21}, {from:10, to:22}, {from:21, to:22}, {from:15, to:23}, 
            {from:22, to:24}, {from:23, to:24}, {from:24, to:25}, {from:25, to:26}, {from:25, to:27}, 
            {from:28, to:27}, {from:27, to:29}, {from:27, to:30}, {from:29, to:30}, {from:8, to:28}, 
            {from:6, to:28}
        ];

        // IEEE 30-Bus Reference Data (Exact copy from PDF Table 1 & 5)
        // Note: PDF values are used as the 'Base' for the simulation
        const ieee30Base = [
            { bus: 1, mag: 0.982, ang: 0, gp: 41.54, gq: -5.44, lp: 0, lq: 0 },
            { bus: 2, mag: 0.979, ang: -0.763, gp: 55.4, gq: 1.67, lp: 21.7, lq: 12.7 },
            { bus: 3, mag: 0.977, ang: -2.39, gp: 0, gq: 0, lp: 2.4, lq: 1.2 },
            { bus: 4, mag: 0.976, ang: -2.839, gp: 0, gq: 0, lp: 7.6, lq: 1.6 },
            { bus: 5, mag: 0.971, ang: -2.486, gp: 0, gq: 0, lp: 94.2, lq: 19.0 },
            { bus: 6, mag: 0.972, ang: -3.229, gp: 0, gq: 0, lp: 0, lq: 0 },
            { bus: 7, mag: 0.962, ang: -3.491, gp: 0, gq: 0, lp: 22.8, lq: 10.9 },
            { bus: 8, mag: 0.961, ang: -3.682, gp: 0, gq: 0, lp: 30, lq: 30 },
            { bus: 9, mag: 0.99, ang: -4.137, gp: 0, gq: 0, lp: 0, lq: 0 },
            { bus: 10, mag: 1.0, ang: -4.6, gp: 0, gq: 0, lp: 5.8, lq: 2 },
            { bus: 11, mag: 0.99, ang: -4.137, gp: 0, gq: 0, lp: 0, lq: 0 },
            { bus: 12, mag: 1.017, ang: -4.498, gp: 0, gq: 0, lp: 11.2, lq: 7.5 },
            { bus: 13, mag: 1.064, ang: -3.298, gp: 16.2, gq: 35.93, lp: 0, lq: 0 },
            { bus: 14, mag: 1.007, ang: -5.04, gp: 0, gq: 0, lp: 6.2, lq: 1.6 },
            { bus: 15, mag: 1.009, ang: -4.814, gp: 0, gq: 0, lp: 8.2, lq: 2.5 },
            { bus: 16, mag: 1.003, ang: -4.839, gp: 0, gq: 0, lp: 3.5, lq: 1.8 },
            { bus: 17, mag: 0.995, ang: -4.887, gp: 0, gq: 0, lp: 9, lq: 5.8 },
            { bus: 18, mag: 0.993, ang: -5.484, gp: 0, gq: 0, lp: 3.2, lq: 0.9 },
            { bus: 19, mag: 0.987, ang: -5.688, gp: 0, gq: 0, lp: 9.5, lq: 3.4 },
            { bus: 20, mag: 0.99, ang: -5.472, gp: 0, gq: 0, lp: 2.2, lq: 0.7 },
            { bus: 21, mag: 1.009, ang: -4.621, gp: 0, gq: 0, lp: 17.5, lq: 11.2 },
            { bus: 22, mag: 1.016, ang: -4.503, gp: 22.74, gq: 34.2, lp: 0, lq: 0 },
            { bus: 23, mag: 1.026, ang: -3.756, gp: 16.27, gq: 6.96, lp: 3.2, lq: 1.6 },
            { bus: 24, mag: 1.017, ang: -3.885, gp: 0, gq: 0, lp: 8.7, lq: 6.7 },
            { bus: 25, mag: 1.044, ang: -2.072, gp: 0, gq: 0, lp: 0, lq: 0 },
            { bus: 26, mag: 1.027, ang: -2.476, gp: 0, gq: 0, lp: 3.5, lq: 2.3 },
            { bus: 27, mag: 1.069, ang: -0.715, gp: 39.91, gq: 31.75, lp: 0, lq: 0 },
            { bus: 28, mag: 0.982, ang: -3.215, gp: 0, gq: 0, lp: 0, lq: 0 },
            { bus: 29, mag: 1.05, ang: -1.849, gp: 0, gq: 0, lp: 2.4, lq: 0.9 },
            { bus: 30, mag: 1.039, ang: -2.643, gp: 0, gq: 0, lp: 10.6, lq: 1.9 }
        ];

        let currentData = JSON.parse(JSON.stringify(ieee30Base));
        let chartInstance = null;

        // --- INIT ---
        window.onload = () => {
            renderTopology();
            renderInputTable();
        };

        function openAuthorModal() {
            document.getElementById('authorModal').classList.remove('hidden');
        }

        function closeAuthorModal() {
            document.getElementById('authorModal').classList.add('hidden');
        }

        function renderTopology() {
            const list = document.getElementById('topologyList');
            list.innerHTML = '';
            branchData.forEach((b, i) => {
                list.innerHTML += `<li class="flex justify-between p-1 hover:bg-blue-50 rounded"><span class="text-xs text-gray-400">L${i+1}</span><span class="text-slate-700">Bus ${b.from} <i class="ph ph-arrow-right text-xs"></i> Bus ${b.to}</span></li>`;
            });
        }

        function renderInputTable() {
            const tbody = document.getElementById('inputTableBody');
            tbody.innerHTML = '';
            currentData.forEach((row, index) => {
                const type = (row.gp > 0) ? 'Gen' : 'Load';
                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50">
                        <td class="px-6 py-3 font-medium text-gray-900">Bus ${row.bus}</td>
                        <td class="px-6 py-3"><span class="px-2 py-1 rounded text-xs font-semibold ${type === 'Gen' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}">${type}</span></td>
                        <td class="px-6 py-3"><input type="number" class="input-edit" value="${row.lp}" onchange="updateInput(${index}, 'lp', this.value)"></td>
                        <td class="px-6 py-3"><input type="number" class="input-edit" value="${row.lq}" onchange="updateInput(${index}, 'lq', this.value)"></td>
                    </tr>
                `;
            });
        }

        function updateInput(index, field, val) {
            currentData[index][field] = parseFloat(val) || 0;
        }

        function resetInputs() {
            currentData = JSON.parse(JSON.stringify(ieee30Base));
            renderInputTable();
        }

        // --- SIMULATION ---
        function runSimulation() {
            document.getElementById('inputState').classList.add('hidden');
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('loadingState').classList.add('flex');
            document.getElementById('runBtn').disabled = true;

            // Mock Simulation Delay
            setTimeout(() => {
                performComplianceCheck();
                performValidation();
                renderResults();
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('loadingState').classList.remove('flex');
                document.getElementById('resultsState').classList.remove('hidden');
                document.getElementById('runBtn').disabled = false;
                document.getElementById('runBtn').innerText = "Rerun";
                switchTab('validation');
            }, 1500);
        }

        function resetSimulation() {
            document.getElementById('resultsState').classList.add('hidden');
            document.getElementById('inputState').classList.remove('hidden');
            document.getElementById('runBtn').innerText = "Run Simulation";
        }

        // --- LOGIC ---
        function performComplianceCheck() {
            const tbody = document.getElementById('complianceTableBody');
            tbody.innerHTML = '';
            let allPassed = true;
            let totalGen = 0, totalLoad = 0;

            currentData.forEach(row => {
                totalGen += row.gp;
                totalLoad += row.lp;

                const v = row.mag;
                const pgcPass = v >= 0.95 && v <= 1.05;
                const pdcPass = v >= 0.90 && v <= 1.10;

                if (!pgcPass) allPassed = false;

                let statusHtml = '';
                if (pgcPass) {
                    statusHtml = '<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-bold">NORMAL</span>';
                } else if (pdcPass) {
                    statusHtml = '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs font-bold">WARNING</span>';
                } else {
                    statusHtml = '<span class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs font-bold">VIOLATION</span>';
                }

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b border-gray-100">
                        <td class="px-6 py-3 font-medium">Bus ${row.bus}</td>
                        <td class="px-6 py-3 font-mono text-blue-600 font-bold">${v.toFixed(3)} p.u.</td>
                        <td class="px-6 py-3">${pgcPass ? '<i class="ph ph-check-circle text-green-500"></i> Pass' : '<i class="ph ph-x-circle text-yellow-500"></i> Fail'}</td>
                        <td class="px-6 py-3">${pdcPass ? '<i class="ph ph-check-circle text-green-500"></i> Pass' : '<i class="ph ph-warning-circle text-red-500"></i> Fail'}</td>
                        <td class="px-6 py-3">${statusHtml}</td>
                    </tr>
                `;
            });

            document.getElementById('complianceStatus').innerText = allPassed ? "PASSED" : "ALERTS";
            document.getElementById('complianceStatus').className = allPassed ? "text-2xl font-bold text-green-600 mt-1" : "text-2xl font-bold text-yellow-600 mt-1";
            document.getElementById('totalGenDisplay').innerText = totalGen.toFixed(2) + " MW";
            document.getElementById('totalLoadDisplay').innerText = totalLoad.toFixed(2) + " MW";
        }

        function performValidation() {
            const tbody = document.getElementById('validationTableBody');
            tbody.innerHTML = '';
            
            // Loop through current results and compare with static base (PDF)
            currentData.forEach((row, i) => {
                const ref = ieee30Base[i];
                
                // Check Voltage Mag
                addValidationRow(tbody, row.bus, 'Voltage Mag', row.mag, ref.mag, 'p.u.');
                // Check Gen P (only if gen bus)
                if(ref.gp > 0) addValidationRow(tbody, row.bus, 'Generation P', row.gp, ref.gp, 'MW');
                // Check Load P (only if load bus)
                if(ref.lp > 0) addValidationRow(tbody, row.bus, 'Load P', row.lp, ref.lp, 'MW');
            });
        }

        function addValidationRow(tbody, bus, param, val, ref, unit) {
            const delta = Math.abs(val - ref);
            const match = delta < 0.001;
            const status = match 
                ? '<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-bold">MATCH</span>'
                : '<span class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs font-bold">DEVIATION</span>';
            
            tbody.innerHTML += `
                <tr class="hover:bg-gray-50 border-b border-gray-100">
                    <td class="px-6 py-3 font-medium">Bus ${bus}</td>
                    <td class="px-6 py-3 text-gray-500">${param}</td>
                    <td class="px-6 py-3 font-mono font-bold">${val.toFixed(3)} ${unit}</td>
                    <td class="px-6 py-3 font-mono text-gray-500">${ref.toFixed(3)} ${unit}</td>
                    <td class="px-6 py-3 font-mono text-xs ${match ? 'text-gray-400' : 'text-red-500'}">${delta.toFixed(4)}</td>
                    <td class="px-6 py-3">${status}</td>
                </tr>
            `;
        }

        function renderResults() {
            const opfBody = document.getElementById('resultsTableBody');
            opfBody.innerHTML = '';
            currentData.forEach(row => {
                opfBody.innerHTML += `
                    <tr class="border-b border-gray-50">
                        <td class="px-6 py-3">${row.bus}</td>
                        <td class="px-6 py-3 font-bold text-blue-600">${row.mag.toFixed(3)}</td>
                        <td class="px-6 py-3">${row.ang}</td>
                        <td class="px-6 py-3 text-green-600">${row.gp > 0 ? row.gp : '-'}</td>
                        <td class="px-6 py-3">${row.lp > 0 ? row.lp : '-'}</td>
                        <td class="px-6 py-3">${row.lq > 0 ? row.lq : '-'}</td>
                    </tr>
                `;
            });

            const ctx = document.getElementById('voltageChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: currentData.map(d => `B${d.bus}`),
                    datasets: [{
                        label: 'Voltage (p.u.)',
                        data: currentData.map(d => d.mag),
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { min: 0.90, max: 1.10, title: {display: true, text: 'Voltage (p.u.)'} } }
                }
            });
        }

        function switchTab(id) {
            ['compliance', 'validation', 'opf', 'voltage'].forEach(t => {
                document.getElementById(`content-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('tab-active');
                document.getElementById(`tab-${t}`).classList.add('tab-inactive', 'border-transparent');
            });
            document.getElementById(`content-${id}`).classList.remove('hidden');
            document.getElementById(`tab-${id}`).classList.add('tab-active');
            document.getElementById(`tab-${id}`).classList.remove('tab-inactive', 'border-transparent');
        }
    </script>
</body>
</html>
